<?php
namespace Emagine\Produto\BLL;

use Emagine\Login\Model\UsuarioInfo;
use Emagine\Produto\Model\LojaInfo;
use Exception;
use Emagine\Base\EmagineApp;
use Emagine\Login\BLL\UsuarioBLL;
use Emagine\Login\BLL\UsuarioPerfilBLL;

class LojaSelecionaPerfilBLL extends UsuarioPerfilBLL
{
    /**
     * @throws Exception
     * @param string $urlFormato
     * @return string
     */
    public function render($urlFormato = "")
    {
        $output = "";
        try {
            $usuario = UsuarioBLL::pegarUsuarioAtual();
            if (!is_null($usuario)) {
                //$urlLoja = "";
                $app = EmagineApp::getApp();
                $regraLoja = new LojaBLL();
                if ($usuario->temPermissao(UsuarioInfo::ADMIN)) {
                    $lojas = $regraLoja->listar();
                }
                else {
                    $lojas = $regraLoja->listarPorUsuario($usuario->getId());
                }

                $loja = null;
                if (count($lojas) == 1) {
                    /** @var LojaInfo $loja */
                    $loja = array_values($lojas)[0];
                }
                elseif (count($lojas) > 1) {
                    $loja = $regraLoja->pegarAtual();
                }
                if (!is_null($loja)) {
                    ob_start();
                    include dirname(__DIR__) . "/templates/loja-perfil.php";
                    $output = ob_get_clean();
                }
                else {
                    return parent::render(); // TODO: Change the autogenerated stub
                }
            }
        } catch(Exception $e) {
            ob_end_flush();
            throw $e;
        }
        return $output;
    }
}